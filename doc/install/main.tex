\documentclass[12pt]{article}

%\usepackage{graphicx}
%\usepackage{setspace}
%\usepackage{datetime}
\usepackage{hyperref}
\usepackage{alltt}
\usepackage{tabularx}
\usepackage{verbatim}
% This fixes table break, but breaks small tables
%\usepackage{ltablex}
%\usepackage{svnkw}
%\usepackage[usenames,dvipsnames]{xcolor}

%\svnidlong
%{$HeadURL$}
%{$LastChangedDate$}
%{$LastChangedRevision$}
%{$LastChangedBy$}

%\newcommand{\todayYMD}{\the\year\twodigit\month\twodigit\day}
\newcommand{\vigClientBranding}{0}
\newcommand{\vigShowNotes}{1}
\newcommand{\vigClientName}{Client Name}
\newcommand{\vigClientNameShort}{client}
\newcommand{\vigProjectName}{SiteSupra 7}
\newcommand{\vigProjectNameShort}{supra7}
\newcommand{\vigPackageSolr}{supra7.solr.3.5.0.REV.zip}
\newcommand{\vigAttn}{Person Name}
%\newcommand{\vigDocumentRevision}{\svnrev}
\newcommand{\vigDocumentRevision}{1}
\newcommand{\vigPackageName}{supra7}
%\newcommand{\vigPathToProject}{\textless path\_to\_project\textgreater}
\newcommand{\vigPathToProject}{/var/www}
\newcommand{\vigPathToSrc}{/src}
\newcommand{\vigPathToWebroot}{\vigPathToSrc/webroot}
\newcommand{\vigReleasePath}{\textasciitilde/}
\newcommand{\vigReleaseVersion}{X.Y.Z}

\newcommand{\note}[1]{
%\ifthenelse{\vigShowNotes=1}{
\textbf{NOTE:} 
%\textcolor{Brown}{
\textit{#1}
%}
%}{}
}

\newcommand{\todo}[1]{
%\ifthenelse{\vigShowNotes=1}{
\textbf{TODO:} 
%\textcolor{Red}{
\textit{#1}
%}
%}{}
}

\setlength{\parindent}{0pt}

\begin{document}
\title{Installation Guide}	

\begin{titlepage}

%\ifthenelse{\vigClientBranding=1}{
%\textbf{Customer:} \vigClientName\\
%\textbf{Project:} \vigProjectName\\
%\textbf{Attn:} \vigAttn
%}

%\begin{center}
\textbf{\huge \vigProjectName}\\
\textbf{\huge Installation Guide}\\
%\todayYMD.VIG.\
%\ifthenelse{\vigClientBranding=1}{\vigClientNameShort.\vigProjectNameShort.}\
%Installation Guide.\vigDocumentRevision

%\end{flushleft}

%\vfill
%
%{\large \today}
%\end{center}

\end{titlepage}

\setlength{\parskip}{0em}
\tableofcontents

\newpage

\normalsize
\setlength{\parskip}{0.5em}

\section*{Copyright}

The information provided here, including but not limited by creative, technical, promotion and information layout ideas, is property of Vide Infra Grupa SIA and is intended for the person or entity to which it is addressed. Taking of any action in reliance upon this information without prior acceptance by Vide Infra Grupa is prohibited. 

Any disclosure, copying, distribution or any action taken or omitted to be taken in reliance on it, is prohibited and may be illegal.

\copyright Vide Infra Grupa%, \the\year

\vspace{2em}

Vide Infra Grupa SIA\\
Baznicas 39-5, Riga\\
LV-1010, Latvia\\
Phone: + (371) 6 729 33 90\\
Fax:  + (371) 6 729 33 45\\
%e-mail: \href{mailto:info@videinfra.com}{info@videinfra.com} \\
e-mail: info@videinfra.com\\
\url{http://www.videinfra.com}

%\ section*{Authorship}
%
%\begin{tabularx}{\textwidth}{X X X}
% \textbf{Name} & \textbf{Email} & \textbf{Phone} \\
% \hline\noalign{\smallskip}
%% Your Name & your@email.com & +371-NNNNNNNN\\
%\end{tabularx}
%
%\ section*{Revision History}
%Previous document ID:
%
%\begin{tabularx}{\textwidth}{l X l l}
% \textbf{Date} & \textbf{\mbox{Changes description}} & \textbf{Location} & \textbf{Initiated by} \\
% \hline\noalign{\smallskip}
%% 2011-01-01 & Blah blah blah blah blah blah blah blah & System requirements & Your Name \\
%\end{tabularx}

\newpage

\section{Introduction}

This document describes system requirements and installation procedure for {\vigProjectName}.

\subsection{Delivery Packages}

Web application is delivered in several packages.

\begin{itemize}
	\item \textbf{{\vigPackageName}.web.\vigReleaseVersion.zip} -- contains web application. It is installed on the Web Server.
	\item \textbf{\vigPackageSolr} -- contains Apache Solr installation and configuration files. It is installed on the Web Server.
	\item \textbf{{\vigPackageName}.dump.\vigReleaseVersion.zip} -- contains database initial installation dump files. It is installed on the database server.
	\item \textbf{{\vigPackageName}.database.\vigReleaseVersion.zip} -- contains database upgrade files. It is installed on the database server.
\end{itemize}

Some of the packages can be not delivered if the corresponding components don't need to be installed or upgraded.

The example commands in this document assumes these packages are downloaded into the system user's home directory \texttt{{\vigReleasePath}}.

Part \textbf{\vigReleaseVersion} in the package filenames denotes product version number. It must be replaced by current version number when executing commands in the further examples.

\section{System Requirements}

\subsection{Web Server}

\subsubsection{Operating System}

Web application should be compatible with any Unix-like operating systems. Linux is the suggested environment.

\subsubsection{Web Server Software}

\begin{enumerate}

\item 
Web server: Apache HTTP Server version 2.2.x or latest from 2.2 branch. The following Apache modules must be installed:
\begin{itemize}
	\item mod\_rewrite;
	\item mod\_php.
\end{itemize}

\item 
PHP version 5.3.10 or latest from 5.3 branch must be installed, freely available at \url{http://www.php.net}. The PHP CLI and Apache HTTP Server module \texttt{mod\_php} must be installed on the Web Server as documented in \url{http://php.net/manual/en/install.unix.php}.

This guide assumes that the \texttt{php} CLI command is in the system path. Specify full path to the executable in the command examples mentioned further if your environment doesn't allow setting the command in the system path.

Required PHP extensions:

\begin{itemize}
\item  \texttt{ctype}
\item  \texttt{curl}
\item  \texttt{fileinfo}
\item  \texttt{filter}
\item  \texttt{freetype}
\item  \texttt{gd} (with gif, jpeg, png support enabled)
\item  \texttt{hash}
\item  \texttt{iconv}
\item  \texttt{json}
\item  \texttt{mbstring}
\item  \texttt{memcache}
\item  \texttt{openssl}
\item  \texttt{pcre}
\item  \texttt{pdo}
\item  \texttt{pdo\_mysql}
\item  \texttt{posix}
\item  \texttt{session}
\item  \texttt{simplexml}
\item  \texttt{xml}
\item  \texttt{zlib}
\end{itemize}

Recommended PHP extensions:
\begin{itemize}
	\item  \texttt{apc}
\end{itemize}

\note{Most popular extra extensions we forget to add are \texttt{zip} (PHPExcel), \texttt{shmop} (GeoIP), \texttt{soap}, \texttt{ldap}.}

\note{PHP 5.3.3 required because "As of PHP 5.3.3, methods with the same name as the last element of a namespaced class name will no longer be treated as constructor. This change doesn't affect non-namespaced classes.". Some Supra classes might have methods with name equal to classname without intention to work as constructor.}
	
\note{At least 5.3.6 is recommended for correct Mysql charset support on connection options without "SET NAMES" initial request.}

\note{At least 5.3.10 is required because segmentation fault might arise with previous versions when page is loaded in the CMS.}

\item
Apache Solr 3.5 or later from version 3 branch must be installed. It is used for website search indexing and querying.

Apache Solr requires Oracle Java Virtual Machine (HotSpot) installed.
%Installation guide is available by address \url{http://wiki.apache.org/solr/SolrInstall}.

\note{At least Solr 3.5 required for Hunspell dictionary support.}

\end{enumerate}

\subsubsection{Modify PHP Configuration}

Use the \texttt{php.ini-production} file bundled with PHP with values recommended for production installations.

Additionally check and modify your php.ini file according to the requirements below:

\begin{itemize}
	\item \texttt{safe\_mode = Off}
	
	\note{Swift mailer uses "proc\_\*" functions}
	
	\item \texttt{memory\_limit = 64MB}
	
	\note{Increase this for bigger projects}
	
	\item Configure these parameters depending the size of media you'll need to upload through the website:
	\\ \texttt{post\_max\_size = 10MB}
	\\ \texttt{upload\_max\_filesize = 10MB}
	
\end{itemize}

\subsubsection{Apache Solr Installation\label{solrInstallation}}

Create folder for Solr installation and unzip solr package into it.

\begin{alltt}
\$ mkdir /opt/solr
\$ cd /opt/solr
\$ unzip \vigPackageSolr
\end{alltt}

Create system user \texttt{solr} for the indexer service. Grant ownership for solr home directory to the new user and make Jetty startup script executable.

\begin{alltt}
\$ useradd -d /opt/solr -s /bin/false solr
\$ chown solr:solr -R /opt/solr
\$ chmod +x /opt/solr/jetty.sh
\end{alltt}

Edit the file \texttt{/opt/solr/jetty.conf}. Check it contains valid \texttt{JAVA\_HOME} environment variable set according to your JVM installation.

You should configure the system to start the Jetty server automatically on system boot.

Start the Jetty service. By default it is bound to localhost:8983 and it won't be accessible by other network. Test it by opening \url{http://localhost:8983/solr/} on the Web Server after starting the service.

\begin{alltt}
\$ /opt/solr/jetty.sh start
\end{alltt}

\subsection{Database Server}
Operating system requirements are the same as for the Web Server.

\subsubsection{Database Server Software}

MySql database server 5.1.16 or latest from 5 branch must be installed. The engine and installation notes are available on \url{http://www.mysql.com}.

Please refer to MySql documentation regarding database administration concepts such as creating users and databases. The documentation is available at \url{http://dev.mysql.com/doc/}.

\subsubsection{Database Server Configuration}

Enter the MySql console and create database user \texttt{supra} with the chosen password. Choose strong not guessable password if the database server can be used by other applications.

\begin{alltt}
CREATE USER 'supra'@'\%' IDENTIFIED BY '<password>';
\end{alltt}

The server must be configured to accept connections from the Web Server.

You can choose another MySql user name. Then it must be changed in further commands and configuration as well.

\subsection{Memcached Server}
Operating system requirements are the same as for the Web Server.

\subsubsection{Memcached Server Software}

Memcached server 1.4.7 or later stable version must be installed. See \url{http://memcached.org/}.

\subsubsection{Memcached Server Configuration}

Use the default memcached configuration. Make sure \textbf{-m} configuration parameter which limits memory usage is at least 64Mb.

The server must accept connections from the Web Server.

\section{Installation}

\subsection{Web Component Installation}

\subsubsection{Unpacking Files}

Extract \textbf{web} component's archive file. The below examples assume web application destination folder is \texttt{{\vigPathToProject}}.

\begin{alltt}
\$ cd \vigPathToProject/
\$ unzip {\vigReleasePath}{\vigPackageName}.web.\vigReleaseVersion.zip
\end{alltt}

\note{Initial content must be provided inside web package. Section "copy files" removed.}

\subsubsection{Change Files and Folders Owner\label{fileOwnerSection}}

Run the command below to set the Apache user as the owner of all application files and folders:

\begin{alltt}
\$ chown -R httpd \vigPathToProject
\end{alltt}

Example assumes the Apache is run under \texttt{httpd} user.

All files and folders under \texttt{\vigPathToProject} directory must be writable by the user \texttt{httpd}.

\note{Fixed list of folders and files which must be writable could be generated as well.}

\subsubsection{Web Application Configuration}
Configure web application by modifying configuration file \texttt{\vigPathToProject\vigPathToSrc/conf/supra.ini}:

\begin{itemize}
	\item Provide database connection details;
	\item Provide \texttt{solr} server configuration;
	\item Configure other parameters according to your needs.
	%\item Any specific supra.ini settings?
\end{itemize}

\subsection{Database Component Installation}

\subsubsection{Create Database}

Enter MySql console using the MySql root user.

Create database by running the following statement:

\begin{alltt}
mysql> CREATE DATABASE \vigProjectNameShort CHARACTER SET UTF8;
\end{alltt}

Grant full permissions to the database for \texttt{supra} MySql user:

\begin{alltt}
mysql> GRANT ALL ON \vigProjectNameShort.* TO supra@'\%';
\end{alltt}

For more security permission can be granted for Web Server host only. Please refer to MySql manual for more information.

\subsubsection{Database Installation}
Extract database component archive and install database by executing the extracted SQL script file from the MySql console.

\begin{alltt}
\$ unzip {\vigReleasePath}{\vigPackageName}.dump.\vigReleaseVersion.zip
\end{alltt}

\begin{alltt}
mysql> use \vigProjectNameShort;
mysql> \textbackslash. {\vigReleasePath}{\vigPackageName}.dump.\vigReleaseVersion.sql
\end{alltt}

\subsection{Scheduled Task Configuration}

Application needs a scheduled task to be installed on the Web Server. The command

\begin{alltt}
\$ php \vigPathToProject/bin/supra su:cron
\end{alltt}

must be run periodically. Recommended period is 1 minute.

Sample \texttt{crontab} configuration line:

\begin{alltt}
* * * * * php \vigPathToProject/bin/supra su:cron
\end{alltt}

\subsection{Apache HTTP Server Host Configuration}

Project may be configured in Apache HTTP Server as virtual host. This is recommended option.

Below is an example of the minimal configuration. The actual configuration of virtual host may vary depending on system specific settings.

\begin{alltt}
<VirtualHost *:80>
  DocumentRoot "\vigPathToProject\vigPathToWebroot"
  <Directory "\vigPathToProject\vigPathToWebroot">
    Order allow,deny
    Allow from all
  </Directory>
  ServerName www.example.com
  ServerAlias example.com
  DirectoryIndex index.php

  RewriteEngine on

  RewriteCond \%\{DOCUMENT_ROOT\}\%\{REQUEST_FILENAME\}.less -f
  RewriteRule ^.*{\textbackslash}.css\$ /cms/lib/supra/combo/combo.php?\$0 [L,NS]
  
  RewriteCond \$0 !^/(cms|components)/ [OR]
  RewriteCond \$0 {\textbackslash}.(gif|jpe?g|png|js|css|html|json|swf|ico)\$ [OR,NC]
  RewriteCond \$0 ^/cms/lib/supra/combo/combo.php\$
  RewriteRule ^.*\$ - [E=SUPRA_STATIC_ALLOW:true]
  
  RewriteCond \%\{DOCUMENT_ROOT\}\%\{REQUEST_FILENAME\} -f
  RewriteCond \%\{ENV:SUPRA_STATIC_ALLOW\} true
  RewriteRule ^ - [L,NS]
  
  RewriteRule ^.*\$ /index.php\$0 [L,NS]
</VirtualHost>
\end{alltt}

Also \texttt{.htaccess} based configuration is possible. The Apache \texttt{DocumentRoot} directive must point to the folder \texttt{\vigPathToProject\vigPathToWebroot} and the \texttt{.htaccess} file must be placed inside it. Apache HTTP Server must be configured to allow \texttt{.htaccess} file usage.

Example of such configuration:

\begin{alltt}
\verbatiminput{example.htaccess}
\end{alltt}

\subsection{SiteSupra CMS account creation}

To be able to sign into the CMS system available by path "/cms/" the first CMS administrator must be created. This can be done from the command line:

\begin{alltt}
\$ php /var/www/bin/supra su:user:create_user \textbackslash
\ \ \ \ --name MyName my@email.com
\end{alltt}

Use your name and email address instead of the sample values. 
Approval email with link to set an account password will be sent to the email address provided.

\note{If the link doesn't work make sure it contains correct domain where the SiteSupra is installed. You can change the project's domain name used in the emails sent by modifying the relevant \texttt{supra.ini} configuration.}

\subsection{Reindex Search\label{reindexSearch}}
Rebuild of search index is required when the database is installed for the first time. Depending on database size, rebuilding of search index may take several minutes. It can be done by running these commands:

\begin{alltt}
\$ php \vigPathToProject/bin/supra su:search:wipe
\$ php \vigPathToProject/bin/supra su:search:wipe_queues
\$ php \vigPathToProject/bin/supra su:search:queue_all_pages
\$ php \vigPathToProject/bin/supra su:search:run_indexer
\end{alltt}

\section{Upgrade Procedure}

\subsection{Overview}
Always backup content folders and database prior to upgrade. The website will not be available during the upgrade.

\subsection{Stop Web Server}
Shut down Apache HTTP Server.

\subsection{Web Component Upgrade}

\subsubsection{Backup Web Application}
Backup your current product web component:

\begin{alltt}
\$ mv \vigPathToProject \vigPathToProject.bak
\end{alltt}

\subsubsection{Install Web Application}
Extract \textbf{web} package in your product installation directory:

\begin{alltt}
\$ mkdir \vigPathToProject
\$ unzip {\vigReleasePath}{\vigPackageName}.web.\vigReleaseVersion.zip -d \vigPathToProject
\end{alltt}

\subsubsection{Configure Web Application}
Edit \texttt{\vigPathToProject\vigPathToSrc/conf/supra.ini} file. You may copy individual values from the old version of the file. Do not copy entire file from the old version because new release configuration file might contain new configuration properties and application might not start when these properties will be missing.

\subsubsection{Copy Content from Backup}
Copy content folder from the backup:

\begin{alltt}
\$ cp -a \vigPathToProject.bak\vigPathToSrc/files/* \vigPathToProject\vigPathToSrc/files/
\$ cp -a \vigPathToProject.bak\vigPathToSrc/webroot/files/* \vigPathToProject\vigPathToSrc/webroot/files/
\end{alltt}

\subsubsection{Change Files and Folders Owner}

See section \ref{fileOwnerSection} for details.

\subsection{Solr Upgrade}

Apache Solr upgrade is required only if solr package is provided in the upgrade release.

Stop Jetty server beforehand.

\begin{alltt}
\$ /opt/solr/jetty.sh stop
\end{alltt}

Backup current solr home directory.

\begin{alltt}
\$ mv /opt/solr /opt/solr.bak
\end{alltt}

Follow instructions from the first time installation in \ref{solrInstallation} except \texttt{solr} user creation part.

Finally start Jetty server.

\begin{alltt}
\$ /opt/solr/jetty.sh start
\end{alltt}

\subsection{Database Component Upgrade}

Database upgrade is required only if database package is provided in the upgrade release.

To upgrade the database component follow the next steps:

\begin{enumerate}
	\item Copy database package {\vigPackageName}.database.\vigReleaseVersion.zip to database server.
	\item Extract the archive.
	\item Perform database backup as \texttt{supra} MySql user.
	\item Run all *.sql files from the database package. Make sure you are executing them in the right order -- each SQL script has its own ordinal number. Execute the scripts in ascending order. Be sure scripts return no errors.
\end{enumerate}

\todo{Currently database upgrades have not been made yet for supra7 projects. Need to think about how this will be done.}

\subsection{Start Web Server}
Start Apache HTTP Server.

\subsection{Reindex Search}

You must reindex the website search if the solr installation has been upgraded. Otherwise the reindex is optional but still recommended after each product upgrade. Please follow the instructions in \ref{reindexSearch}.

\end{document}
