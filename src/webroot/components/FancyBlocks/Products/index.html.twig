{% set width_full = 960 %}
{% set height_full = 600 %}
{% set width_small = 420 %}
{% set width_icon = 64 %}

{# <!-- Macro for outputing images --> #}
	{% macro imageHtmlTag (image, width, height) %}
		
		{% if not width %}{% set width = image.crop_width %}{% endif %}
		{% if not height %}{% set height = image.crop_height %}{% endif %}
		
		{# {{ supraBlock.preloadImage( image.imageId, width, height, true, image.size_name ) }} #}
		
		{% set tag = supraBlock.imageHtmlTag( image.imageId, width, height, true, image.size_name )|raw %}
		{% set width = tag.getAttribute('width') %}
		{% set height = tag.getAttribute('height') %}
		{% set ratio = width / height %}
		
		{% if width < 420 %}
			{# <!-- Larger image for table and mobile --> #}
			{% set width_mobile = 420 %}
			{% set tag_mobile = supraBlock.imageHtmlTag( image.imageId, width_mobile, width_mobile / ratio, true )|raw %}
		{% endif %}
		
		<img src="{{ tag.getAttribute('src') }}" width="{{ width }}" height="{{ height }}" {% if width < 420 %}
			 data-src-desktop="{{ tag.getAttribute('src') }}" data-height-desktop="{{ height }}"
			 data-src-mobile-all="{{ tag_mobile.getAttribute('src') }}" data-height-mobile-all="{{ tag_mobile.getAttribute('tag_mobile') }}"
			 class="responsive"
			 {% endif %}alt="" />
		
	{% endmacro %}
	{% import _self as output %}





{% set navigation = supraBlock.property('navigation')|default('scrollbar') %}
{% set design = supraBlock.property('design')|default('box') %}
{% set products = supraBlock.property('images') %}
{% set layout = supraBlock.property('layout') %}
{% set image = supraBlock.property('image') %}
{% set link = supraBlock.property('link') %}
{% set link_title = '' %}

{% set ratio = 0.7 %}

{% if layout == 'columns_3' %}
	{% set columns = 3 %}
{% elseif layout == 'columns_2' %}
	{% set columns = 2 %}
{% else %}
	{% set columns = 4 %}
{% endif %}

{% if design == 'border' %}
	{% set padding = 30 %}
{% elseif design == 'box' %}
	{% set padding = 60 %}
{% else %}
	{% set padding = 20 %}
{% endif %}


{# Macro for outputing images #}
	
	{# Calculate image width based on layout, design and screen size #}
	{% macro imageWidth (screen, columns, padding) %}
		{% set image = supraBlock.property('image') %}
		
		{% if image == 'icon' %}
			{{ width_icon }}
		{% else %}
			{% if screen > 420 %}
				{{ (screen - padding * columns) / columns }}
			{% else %}
				{{ screen - padding * columns }}
			{% endif %}
		{% endif %}
	{% endmacro %}
	
	{# Output image tag for CMS Gallery manager #}
	{% macro imageCMS(ratio, columns, padding) %}
		{% import _self as output %}
		{% set image = supraBlock.property('image') %}
			
		{% if image == 'icon' %}
			<span class="img">
				<img src="about:blank" alt="" width="{{ width_icon }}" height="{{ width_icon }}" />
			</span>
		{% else %}
			{% set screenWidth = 960 %}
			{% set w = output.imageWidth(screenWidth, columns, padding)|trim|raw|number_format(0, '.', '') %}
			{% set h = w*ratio|number_format(0, '.', '') %}
			<span class="img">
				<img src="about:blank" alt="" width="{{ w }}" height="{{ h }}" />
			</span>
		{% endif %}
	{% endmacro %}

{# Macro for outputing links #}
	{% macro link(product, link_type) %}
		{% if product.property.link %}
			{% if product.property.link.title %}
				{% set link_title = product.property.link.title %}
			{% elseif product.property.link.page %}
				{% set link_title = product.property.link.page.title %}
			{% else %}
				{% set link_title = product.property.link.url %}
			{% endif %}
			
			{% if link_type == 'button' %}
				<a class="button" href="{{product.property.link.url}}" target="{{product.property.link.target}}"><span><span>{{ product.property.link_label|default( link_title ) }}</span></span></a>
			{% elseif link_type == 'text' %}
				<a class="link" href="{{product.property.link.url}}" target="{{product.property.link.target}}">{{ product.property.link_label|default( link_title ) }}</a>
			{% elseif link_type == 'overlay' %}
				<a class="overlay" href="{{product.property.link.url}}" target="{{product.property.link.target}}" title="{{ product.property.link_label|default( link_title ) }}"></a>
			{% endif %}
		{% endif %}
	{% endmacro %}

{# Macro for outputing text + link #}
	{% macro text(product, link_type) %}
		{% import _self as output %}
		
		<h2>{{ product.property.title }}</h2>
		<p>{{ product.property.description }}</p>
		
		{% if link_type == 'button' or link_type == 'text' %}			
			{{ output.link(product, link_type) }}
		{% endif %}
	{% endmacro %}

{# Macros needs to be imported before use #}
{% import _self as output %}


{% if products|length or supra.cmsRequest %}

	<div class="block">
		
		{% if not supraBlock.isEmpty('block_title') %}
		<h2 class="block-title"><div>
			{{ supraBlock.property('block_title') }}
		</div></h2>
		{% endif %}
		
		<div class="products-slider clearfix style-{{ design }} img-{{ image }} link-{{ link }}" data-refresh-event="carousel" data-style="{{ design }}" data-{{ navigation }}="true">
			<ul class="clearfix">
				{% for index, product in products %}
					{% if index and index % 4 == 0 %}
						<li class="clear"></li>
					{% endif %}
					
					<li class="{% if loop.first %}alpha {% endif %}{% if loop.last %}omega {% endif %}{% if layout == 'columns_3' %}one_third{% elseif layout == 'columns_2' %}grid_8{% else %}grid_4{% endif %} {% if design != 'box' %}clearfix{% endif %}">
						
						{% if design == "box" %}
							
							<div class="outer clearfix">
								{# Text and then image, unless it's icon mode #}
								
								{% if link == 'overlay' %}
									{{ output.link(product, link) }}
								{% endif %}
								
								{% if image == 'icon' %}
									<span class="img">
										{{ output.imageHtmlTag( product, width_icon, width_icon ) }}
									</span>
								{% endif %}
								
								{% if image != 'only' %}
									<div class="inner-text">
										{{ output.text(product, link) }}
									</div>
								{% endif %}
								
								{% if image != 'icon' %}
									{{ output.imageHtmlTag( product ) }}
								{% endif %}
								
							</div>
							
						{% else %}
							{# Image followed by text #}
							
							{% if image == 'icon' %}
								<span class="img">
									{{ output.imageHtmlTag( product, width_icon, width_icon ) }}
								</span>
							{% else %}
								{{ output.imageHtmlTag( product ) }}
							{% endif %}
							
							{% if image != 'only' %}
								<div class="inner-text">
									{{ output.text(product, link) }}
								</div>
							{% endif %}
							
							{% if link == 'overlay' %}
								{{ output.link(product, link) }}
							{% endif %}
							
						{% endif %}
					</li>
				{% endfor %}
				
				<li class="clear"></li>
			</ul>
		</div>
		
		
		{# Instructions how to render item in CMS Gallery manager edit mode #}
		{% if supra.cmsRequest %}{% raw %}
			<script type="text/supra-template" data-supra-container-selector="ul" data-supra-id="gallerymanager-item">
				
				<li class="{% if layout == 'columns_3' %}one_third{% elseif layout == 'columns_2' %}grid_8{% else %}grid_4{% endif %} {% if design != 'box' %}clearfix{% endif %}">
					{% if design == "box" %}
					
						<div class="outer clearfix">
							
							{% endraw %}{% if image == 'icon' %}
								{{ output.imageCMS(ratio, columns, padding) }}
							{% endif %}{% raw %}
							
							{% if image != 'only' %}
							<div class="inner-text">
								<h2>{{ property.title }}</h2>
								<p>{{ property.description }}</p>
								
								{% if link == 'button' %}
									<a class="button"><span><span>{{ property.link_label }}</span></span></a>
								{% elseif link == 'text' %}
									<a class="link">{{ property.link_label }}</a>
								{% endif %}
							</div>
							{% endif %}
							
							{% endraw %}{% if image != 'icon' %}
								{{ output.imageCMS(ratio, columns, padding) }}
							{% endif %}{% raw %}
						</div>
						
					{% else %}
						
						{% endraw %}{{ output.imageCMS(ratio, columns, padding) }}{% raw %}
						
						{% if image != 'only' %}
							<div class="inner-text">
								<h2>{{ property.title }}</h2>
								<p>{{ property.description }}</p>
							
								{% if link == 'button' %}
									<a class="button"><span><span>{{ property.link_label }}</span></span></a>
								{% elseif link == 'text' %}
									<a class="link">{{ property.link_label }}</a>
								{% endif %}
							</div>
						{% endif %}
						
					{% endif %}
				</li>
				
			</script>
		{% endraw %}{% endif %}
		
	</div>
	
{% endif %}